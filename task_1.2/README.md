# Smart Home Microservices

## Описание

Проект "Smart Home Microservices" представляет собой микросервисное приложение для управления отоплением, освещением, воротами.
Также присутствует функционал мониторинга состояния различных датчиков. Есть возможность настраивать различные автоматические сценарии работы.
Пользователи могут самостоятельно устанавливать и подключать новые устройства.

## Функционал приложения
Управление отоплением:
* Пользователи могут удалённо включать/выключать отопление в своих домах.
* Пользователи могут устанавливать желаемую температуру.
* Система автоматически поддерживает заданную температуру, регулируя подачу тепла.

Управление освещением:
* Пользователи могут удаленно включать/выключать освещение в своих домах, отдельных комнатах в доме.

Управление воротами:
* Пользователи могут удаленно открывать/закрывать ворота в доме

Управление сценариями:
* Пользователи могут создавать и настраивать автоматические сценарии работы систем (Например включение отопления в заданное время)

Мониторинг:
* Система получает данные о температуре с датчиков, установленных в домах.
* Пользователи могут просматривать текущую температуру в своих домах через веб-интерфейс.
* Пользователи могут просматривать текущее состояние систем отопления (вкл/выкл)
* Пользователи могут просматривать текущее состояние систем освещения (вкл/выкл)
* Пользователи могут просматривать текущее состояние ворот (открыто/закрыто)


## DDD
По DDD приложение можно разбить на следующие домены и поддомены:

Домен: Управление устройствами
- Поддомен регистрации новых устройств
- Поддомен управления отоплением
- Поддомен управления освещением
- Поддомен управления воротами

Домен: Управление сценариями
- Поддомен создания/редактирования сценариев

Домен: Мониторинг 
- Поддомен получения и хранения данных температуры (телеметрия)
- Поддомен мониторинга состояния устройств

[Диаграмма контекста C4](C4_context.puml)

## Микросервисы

В соответствии с разбиением на домены и поддомены можно выделить несколько микросервисов:
1. Сервис управления устройствами:
* Отправление команд на устройства для изменения их состояния
* Хранение устройств в БД
* БД Postgres
2. Сервис управления сценариями:
* Хранение сценариев в БД
* Отслеживание крон-задач
* Отслеживание показателей устройств, для запуска сценариев по условию
* БД Postgres
3. Сервис мониторинга и телеметрии:
* Асинхронный запрос данных с устройств
* Публикация данных в очередь сообщений для остальных сервисов
* Хранение истории показателей в БД
* БД Timeseries типа(InfluxDB или Clickhouse)
4. Сервис маршрутизации и обнаружения устройств:
* Публикация события о регистрации нового устройства
* Хранение IP-адресов коробок в БД 
* Проксирование запросов к коробкам и от коробок в сервисы
* БД Postgres
5. Шина данных (Kafka)
6. API Gateway


ВАЖНО:
**Сервисы авторизации и управления учетными записями не являются ключевыми для этого задания. Поэтому в решении участвовать не будут**

## Взаимодействия и процессы

* Процесс управления устройствами:  
Пользователь через API Gateway, Сервис управления устройствами и Сервис маршрутизации отправляет команду на конкретную коробку и конкретное устройство.  

* Процесс выполнения сценариев:  
Сервис сценариев отслеживает данные по конкретным устройствам, реагируя запуском настроенного сценария.
Сценарий запускается либо как крон задача, либо как реакция на определенные пороговые значения.
При выполнении сценария управляет устройствами через Сервис управления устройствами.  

* Процесс мониторинга и телеметрии:  
Предполагается что Коробка управления устройствами с определенным периодом опрашивает свои устройства и публикует результаты в Очередь сообщений через Сервис маршрутизации и обнаружения. Сервисы реагируют на события.  
Также есть возможность через Сервис маршрутизации запросить текущие данные с устройства синхронно.

* Процесс регистрации нового устройства в коробке:  
При подключении нового устройства Коробка управления определяет его и отправляет через Сервис маршрутизации  и обнаружения событие в очередь о регистрации нового устройства, сообщая id коробки, id устройства, тип устройства для общения с ним.
Коробка начинает отдавать телеметрию устройства.
Сервис управления получает событие о новом устройстве для коробки и сохраняет себе в БД новое устройство и и его тип.

  
## Сущности

* Пользователь(User):  
id - id пользователя  
name - имя пользователя  
password - пароль


* Дом(House):  
id - id дома  
user_id - id владельца дома   
name - имя для дома  

  
* Коробка управления(Модуль)(Module):  
id - id модуля  
house_id - id дома где стоит коробка  
name - отображаемое имя  
status - статус модуля(доступен/недоступен/перезагружается/обновляется). Числовое значение соответствующее статусу


* Устройство(Device):  
id - id устройства  
module_id - id модуля, в котором стоит устройство  
serial - серийный номер  
name - отображаемое имя  
type - тип устройства  
status - статус устройства(вкл/выкл/перезагружается/обновляется). Числовое значение соответствующее статусу


* Тип устройства(DeviceType):  
id - id типа  
protocol - номер протокола общения. Числовое значение.


* Телеметрия(TelemetryData):  
id - id записи  
device_id - id устройства от которого получена телеметрия  
value - полученное значение телеметрии  
date - время получения значения  
type - тип данных(пока что только температура?). Числовое значение


Описаны только ключевые сущности. Такие сущности как сценарии, адреса устройств - не будут описаны. Не уверен что это нужно по заданию.



